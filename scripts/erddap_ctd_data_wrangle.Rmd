---
title: "2019 GoA CTD Data "
author: "Brett Johnson"
date: '`r date()`'
output:
 html_document:
   theme: cosmo
   number_sections: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)

library(googledrive)
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(parsedate)
```

- Download Data

```{r download data}

sheet2 <- read_csv(here("original_data", "Data_IYS_conbined_Final-Sheet2.csv"))

```

- Change date to ISO 8601 format (eg. `r format_iso_8601(as.POSIXct(Sys.time(), format = "%Y-%m-%d %H:%M%:S", tz="Asia/Kamchatka"))`) by adding together the year, month, day, and shiptime columns. 

```{r Date ISO 8601}
sheet2 <- sheet2 %>%
  mutate(eventDate_text = str_c(YEAR, MONTH, DAY, `TIME(ship time)`, `MIN(ship time)`, sep="-"),
         eventDate = ymd_hm(eventDate_text, tz = "Asia/Kamchatka")) %>%
  mutate(eventDate = format_iso_8601(as.POSIXct(eventDate,
                                                format = "%Y-%m-%d %H:%M%:S",
                                                tz="Asia/Kamchatka")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z")
  ) %>% 
  select(-eventDate_text)
```

- The longitude was recorded as positive values, however, after QC and cross-reference to other data recorded during the same cruise, it is clear that the values should be negative.

```{r}
sheet2$LON <- -sheet2$LON
```

- Re-write column names for clarity

```{r}
combined_event_ctd <- sheet2 %>% 
  mutate(cruise_name = "GoA2019",
         vessel_name_abbr = "Kaganovsky",
         zone = "NA",
         event_type = "CTD",
         station_event_ID = paste(cruise_name, zone, `NO.(CTD)`, event_type, 
                                  sep = "-"),
         year = year(eventDate),
         month = month(eventDate),
         day = day(eventDate),
         time_zone_code = "UTC",
         minimum_sampling_depth_meters = 0,
         instrument_type = "CTD", instrument_model = "SBE 25 Sealogger CTD") |> 
  group_by(station_event_ID) |> 
  mutate(maximum_sampling_depth_meters = max(DEPTH)) |> 
  ungroup() |> 
  select(cruise_name, vessel_name_abbr, zone, "station" = `NO.(ST)`, event_type,
         station_event_ID, day, "time_start" = `TIME(ship time)`, 
        "event_date" = eventDate,  time_zone_code, minimum_sampling_depth_meters, 
         maximum_sampling_depth_meters, latitude_start_decdeg = LAT, 
        longitude_start_decdeg = LON, bottom_depth_meters = `Bot. Depth`,
   instrument_type, instrument_model,
    "sea_water_temperature" = `TEM_S`,
    "sea_water__salinity" = `SAL_S`,
    "sea_water_conductivity" = `Cond. [mS/cm]_R`,
    "sea_water_EC25" = `EC25 [uS/cm]_R`,
    "sea_water_density" = `Density [kg/m^3]_R`,
    "sea_water_sigma_t" = `SigmaT [ ]_R`,
    "sea_water_turbidity" = `Turb-M [FTU]_R`,
    "sea_water_chlorophyll_fluorescence" = `Chl-Flu. [ppb]_R`,
    "sea_water_chlorophyll_a_concentration" = `Chl-a [ug/l]_R`,
    "sea_water_dissolved_oxygen" = `DO [mg/l]_R`,
    "sea_water_dissolved_oxygen_saturation" = `DO [%]_R`,
    "sea_water_concentration_of_oxygen" = `O2 [ml/l]`,
    "sea_water_pH" = pH,
    "BOD5" = `BOD5[ml/l]`
    ) 

```

```{r}
write_csv(combined_event_ctd, here("standardized_data", "IYS_2019_CTD.csv"))
```

